---
- name: install and configure couch cluster
  hosts: servers
  remote_user: ubuntu
  become: yes
  become_user: root
  
  vars:
   ansible_ssh_private_key_file: /Users/siddharth/Documents/GitHub/cluster-n-cloud-computing/ansible/Default-cloud.key
   host_key_checking: False
   command_warnings: False
   
- hosts: myhost
  tasks:
   - name: install git 
     apt: name=git state=present
   
   - name: install python 3
     apt: name=python3 state=present

   - name: install pip
     apt: name=python-pip state=present

   - name: clone docker repo into root folder
     git: 
        repo: https://github.com/redgeoff/docker-ce-vagrant
        clone: yes
        dest: /root/docker-ce-vagrant

   - name: update apt cache
     apt: 
        update_cache: yes

   - name: change into repository directory and install docker
     shell: "/root/docker-ce-vagrant/docker.sh"

   - name: make directory to save data
     file: path=/home/ubuntu/common state=directory

   - name: install docker-py
     pip: name=docker-py state=present

   - name: run couchdb docker
     docker_container:
        name: couchdb
        image: redgeoff/couchdb
        state: started
        restart_policy: always
        log_options:
          max-size: 100m
        published_ports: "[{% for port in range(9100, 9201) %}'{{port}}:{{port}}'{% if not loop.last %},{% endif %}{% endfor %},'4369:4369','5984:5984','5986:5986']"
        volumes:
          - /home/ubuntu/common:/home/couchdb/common 
        env:
            COUCHDB_DATA_DIR: "/home/couchdb/common/data"
            COUCHDB_USER: "admin"
            COUCHDB_HASHED_PASSWORD: "-pbkdf2-b1eb7a68b0778a529c68d30749954e9e430417fb,4da0f8f1d98ce649a9c5a3845241ae24,10"
            COUCHDB_COOKIE: "mycookie"
            COUCHDB_NODE_NAME: "{{ inventory_hostname }}"

   - name: add node source
     shell: "curl -sL https://deb.nodesource.com/setup_8.x | sudo -E bash -"
     
   - name: install npm
     apt: name={{ item }} update_cache=yes state=latest
     with_items:
        - build-essential
        - nodejs
    

   
   
 
       




   